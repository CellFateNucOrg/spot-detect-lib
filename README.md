
# spot-detect-lib

This repository focuses on spot detection in microscopic images with segmented nuclei.

To get started, clone this Git repository. While scripts are optimized for GPU and multi-core processing on servers, you can also clone it to a local computer.

```bash
git clone https://github.com/CellFateNucOrg/spot-detect-lib.git
```
---

## 1. Segmentation

The segmentation process leverages previous scripts, utilizing CellPose and a pretrained model.

**To run a segmentation:**

1.  Open the `nuclei_segmentation.sh` script on your cluster.
2.  **Crucially, change the folder locations** to folders to your image files.

This script supports **.nd2** and **.tif** image files. While **.czi** format was under development, it's currently recommended to convert **.czi** files to **.tif** before processing.

The segmentation script involves two main steps: **Segmentation** and **Analysis**. You can customize various settings by using command-line flags as demonstrated below:

```bash
python -m segmentation.cli segment \
    --raw-dir        "${RAW_DIR}" \
    --denoised-dir "${DENOISED_DIR}" \
    --pattern        "*.nd2" \
    --model          "${MODEL_DIR}" \
    --out-root       "${OUT_ROOT}" \
    --gpu \
    --do-qc \
    --blur-sigma 1.5
```

### Available Segmentation Flags

Here's a breakdown of the available flags for the segmentation process:

* **`--raw-dir`** (required)
    *  Specifies the folder containing your input image files (**.nd2**, **.czi**, or **.tif**).
* **`--denoised-dir`** (optional)
    *  Specifies the folder containing denoised **.tif** files, if available.
* **`--pattern`** (default: `*.nd2`)
    *  A glob pattern to filter raw images (e.g., `'*.nd2'`, `'*.czi'`, `'*.tif'`).
* **`--model`** (required)
    *  Path to the Cellpose model folder.
* **`--out-root`** (required)
    *  The root directory where all output files will be saved.
* **`--gpu` / `--cpu`** (default: `--gpu`)
    *  Toggles between using **GPU** acceleration or **CPU** for processing.
* **`--do-qc` / `--no-qc`** (default: `--no-qc`)
    *  Enables or disables saving Quality Control (**QC**) images of the segmentation results.
* **`--invert` / `--no-invert`** (default: `--no-invert`)
    *  Controls whether image intensities are inverted before segmentation.
* **`--blur-sigma`** (optional)
    *  Applies an optional Gaussian blur with a specified sigma value before segmentation.

**Upcoming Feature:** I will implement a possibility to change the nuclei diameter. For high-resolution images, I manually changed the `diameter: float = 125` parameter in `segment.py` (for confocal images, it was `None` as the model performed well with autodetection).

---

## 2. Spot Detection

The spot detection algorithm relies on data generated by the nuclei segmentation algorithm. Therefore, you must have `nuclei` and `segmentation` folders present to analyze spots.

**To change analysis settings:**

* Currently, you need to navigate to the `spot_detection/main.py` script and manually adjust the settings. I plan to implement a flag system once the analysis is well-established, but for now, it requires direct modification.

**Important Note for High-Resolution Images:**

To analyze original high-resolution images, you must use the `split_5d_tiff_to_timepoints` function within `main.py`. Change the input directory to `input_dir=OUTPUT_DIR / "raw_images_timelapse"`. This is necessary because the original images are too large to handle directly, and their timepoints need to be split.

**To modify spot feature detection:**

* Navigate to `batch_spot_analysis.py` and adjust the parameters within the `process_single_image` function.

---

## Apptainer on IZB cluster

### Container
The continer to execute the scripts is located in the folder on IZB cluster /mnt/external.data/MeisterLab/mvolosko/spot_detection_environment

There are few important files to consider.
The first one is `Sponuc.def` - an image with which the container was built locally. 
This image creates a container called `sponuc.sif`, which includes the drivers needed for GPU execution on the cluster. It works with current version of Cuda toolkit 12.9.0. In the future this might need to be updated.
To build a container, you need to install the Apptainer locally and run the following command:
```bash
apptainer build sponuc.sif Sponuc.def
```

After you can transport the container file `sponuc.sif` to the server and use it there.

### Python envorinment
Then the micromamba environment was created in the sponuc-env using `sponuc_env.yml`. 
```bash
apptainer exec --nv sponuc.sif micromamba create -y -p /envs/sponuc -f sponuc_env.yml
```
This environment was installed with minimum requirments, to avoid packages incompatibility. And later the needed packages were installed with requirments.txt via pip.
In order to install new or update packages inside the environment, the following command should be executed in the spot_detection_environment folder:
```bash
apptainer exec --nv sponuc.sif micromamba run -p ./sponuc-env pip install -r requirements.txt #you should update the requirments.txt with packages you want to have
```

