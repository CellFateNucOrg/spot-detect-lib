
# spot-detect-lib

This repository focuses on spot detection in microscopic images with segmented nuclei.

To get started, clone this Git repository. While scripts are optimized for GPU and multi-core processing on servers, you can also clone it to a local computer.

```bash
git clone https://github.com/CellFateNucOrg/spot-detect-lib.git
```
---

## 1. Segmentation

The segmentation process leverages previous scripts, utilizing CellPose and a pretrained model.

**To run a segmentation:**

1.  Open the `nuclei_segmentation.sh` script on your cluster.
2.  **Crucially, change the folder locations** to point to your image files.

This script supports **.nd2** and **.tif** image files. While **.czi** format was under development, it's currently recommended to convert **.czi** files to **.tif** before processing.

The segmentation script involves two main steps: **Segmentation** and **Analysis**. You can customize various settings by using command-line flags as demonstrated below:

```bash
python -m segmentation.cli segment \
    --raw-dir        "${RAW_DIR}" \
    --denoised-dir "${DENOISED_DIR}" \
    --pattern        "*.nd2" \
    --model          "${MODEL_DIR}" \
    --out-root       "${OUT_ROOT}" \
    --gpu \
    --do-qc \
    --blur-sigma 1.5
```

### Available Segmentation Flags

Here's a breakdown of the available flags for the segmentation process:

* **`--raw-dir`** (required)
    * **Description:** Specifies the folder containing your input image files (**.nd2**, **.czi**, or **.tif**).
* **`--denoised-dir`** (optional)
    * **Description:** Specifies the folder containing denoised **.tif** files, if available.
* **`--pattern`** (default: `*.nd2`)
    * **Description:** A glob pattern to filter raw images (e.g., `'*.nd2'`, `'*.czi'`, `'*.tif'`).
* **`--model`** (required)
    * **Description:** Path to the Cellpose model folder.
* **`--out-root`** (required)
    * **Description:** The root directory where all output files will be saved.
* **`--gpu` / `--cpu`** (default: `--gpu`)
    * **Description:** Toggles between using **GPU** acceleration or **CPU** for processing.
* **`--do-qc` / `--no-qc`** (default: `--no-qc`)
    * **Description:** Enables or disables saving Quality Control (**QC**) images of the segmentation results.
* **`--invert` / `--no-invert`** (default: `--no-invert`)
    * **Description:** Controls whether image intensities are inverted before segmentation.
* **`--blur-sigma`** (optional)
    * **Description:** Applies an optional Gaussian blur with a specified sigma value before segmentation.

**Upcoming Feature:** I will implement a possibility to change the nuclei diameter. For high-resolution images, I manually changed the `diameter: float = 125` parameter in `segment.py` (for confocal images, it was `None` as the model performed well with autodetection).

---

## 2. Spot Detection

The spot detection algorithm relies on data generated by the nuclei segmentation algorithm. Therefore, you must have `nuclei` and `segmentation` folders present to analyze spots.

**To change analysis settings:**

* Currently, you need to navigate to the `spot_detection/main.py` script and manually adjust the settings. I plan to implement a flag system once the analysis is well-established, but for now, it requires direct modification.

**Important Note for High-Resolution Images:**

To analyze original high-resolution images, you must use the `split_5d_tiff_to_timepoints` function within `main.py`. Change the input directory to `input_dir=OUTPUT_DIR / "raw_images_timelapse"`. This is necessary because the original images are too large to handle directly, and their timepoints need to be split.

**To modify spot feature detection:**

* Navigate to `batch_spot_analysis.py` and adjust the parameters within the `process_single_image` function.

---

## To Do List

* Implement a diameter setting in segmentation scripts.
* Develop spot detection functionality without requiring prior nuclei segmentation.
* Integrate a command-line interface (CLI) system for spot detection scripts, allowing settings to be configured via shell scripts without modifying Python source code.
* Continue to improve the spot detection system (ongoing development).
